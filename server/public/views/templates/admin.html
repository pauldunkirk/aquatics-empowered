<nav ng-include="'views/templates/nav.html'"></nav>
<div class="container">

  <div class="row">
    <h2>Admin Page - Running on {{vm.dbType}} database</h2>
  </div>

  <hr>

  <div class="row">
    <h3>Choose which of biggest 1000 cities in USA to search</h3>
    <form flex="50" id="surveySearch">
      <input placeholder="filter cities" ng-model="cityQuery" ng-change="vm.c.pageCheck((vm.c.cityList  | filter: cityQuery |  excludeByStatus: vm.c.show.text()).length)" />
      <div class="errors-spacer"></div>
    </form>
    <h4 flex="25" id="surveySearchResults">Results: {{(vm.c.cityList  | filter: cityQuery | excludeByStatus:vm.c.show.text()).length}}</h4>
  </div>


  <div class="row">
      <span>click column heading to sort</span>
    <div class="col-md-6">
      <table cellspacing="0">
        <thead>
          <tr id="headerRow">
            <th class="columnSort" width="55" ng-click="vm.c.setSort('include')">Select&nbsp</th>
            <th class="columnSort" ng-click="vm.c.setSort('city')">City</th>
            <th class="columnSort" ng-click="vm.c.setSort('state')">State</th>
          </tr>
        </thead>

        <tbody class="tableBody">
          <tr class="tableBodyRow" data-ng-repeat="res in vm.c.cityList | excludeByStatus: vm.c.show.text() | orderBy:vm.c.sortType:vm.c.sortReverse | filter: cityQuery | startFrom:vm.c.currentPage*vm.c.pageSize | limitTo:vm.c.pageSize" >
            <td><input type="checkbox" ng-model="res.include" /></td>
            <td class="longTd">{{res.city}}</td>
            <td class="longTd">{{res.state}}</td>
          </tr>
        </tbody>
      </table>

      <div class="row" ng-show="vm.c.totalPages((vm.c.cityList  | filter: query |  excludeByStatus: vm.c.show.text()).length)" >
        <button ng-class="mini" ng-disabled="vm.c.currentPage == 0" ng-click="vm.c.currentPage=vm.c.currentPage-1">
          Previous
        </button>
          {{vm.c.currentPage+1}}/{{vm.c.totalPages((vm.c.cityList  | filter: query | excludeByStatus: vm.c.show.text()).length)}}
        <button ng-class="mini" ng-disabled="vm.c.currentPage >= ((vm.c.cityList  | filter: cityQuery | excludeByStatus: vm.c.show.text()).length / vm.c.pageSize - 1)" ng-click="vm.c.currentPage=vm.c.currentPage+1">
          Next
        </button>
      </div>
    </div>
  </div>
  <div class="row">
    <h4>Takes city coordinates and retrieves google place id for up to 200 places per city based on keywords</h4>
    <form class="specialTools form-group" ng-submit="vm.gPlaces.findIds(num)">
      <input class="form-control" type="text" placeholder="keywords" required ng-disabled="vm.citiesLeft[0]" ng-model="vm.keywords">
      <input class="form-control" type="text" required ng-model="vm.cityCoordsUrl">
      <input class="btn" type="submit" value="query selected cities, add to Radar Table" ng-disabled="!(vm.keywords)">
    </form>
    <h4 ng-if="vm.citiesLeft[0]">
      {{vm.citiesLeft[0]}} cities remaining <br />
      {{vm.errorCount}} errors
    </h4>
  </div>

<hr>

  <div class="row">
    <h2>Gather Details</h2>
    <h4>Gathers detailed info with the Google place ids from above</h4>
    <button class="btn" ng-click="vm.gPlaces.getIdList()">
      Get PlaceIds from Radar Table (uses no API queries)
    </button>
    <br/>
    <form ng-if="vm.gPlaceIdList.length">
      <br />
      <input type="checkbox" ng-model="vm.requireReviews" />
      MUST have Google Review(s) to add to DB.
    </form>
    <button class="btn"
        ng-disabled="!vm.gPlaceIdList.length"
        ng-click="vm.gPlaces.getInfoFromIds(vm.gPlaceIdList)">
      {{vm.gPlaceIdList.length ? "Add Google Info for ALL Place IDs to DB! (uses API queries)" : "Get Place Ids First"}}
    </button>
    <span>Current API query limit 2k per day</span>
    <h4>Number of google place ids: {{vm.gPlaceIdList.length}}</h4>
    <h4 ng-if="vm.placesLeft[0]">
      {{vm.placesLeft[0]}} places remaining <br />
      {{vm.errorCount}} errors
    </h4>
  </div>


<hr>

  <div class="row">
    <h3>Stop Queries!</h3>
    <button class="btn" ng-disabled="!vm.pulsing" ng-click="vm.abort=true">
      Stop pulsing all Google queries
    </button>
  </div>

<hr>

  <div class="row">
    <h4><br />{{vm.dbType}} Database, GOOGLE_RADAR_RESULTS table:</h4>
    <button class="btn-danger" ng-click="vm.db.cleanIdList()">
       Delete NULL placeId entries and <br />placeIds that exist within facilities table
    </button>
    <button class="btn-danger" ng-click="vm.deleteAllRadarTable()">
      Delete ALL from Radar Table
    </button>
    <h4><br />{{vm.dbType}} Database, FACILITIES table:</h4>
    <button class="btn-danger" ng-click="vm.db.cleanFacilities()">
       Delete facilities with no google_places_data
    </button>
  </div>

<hr><hr><hr>

  <!-- DATABASE VIEW table set up  -->
  <div class="row">
    <h2>Database View</h2>
    <form flex="50" id="surveySearch">
      <label>Search Pools in Database</label>
      <input ng-model="query" ng-change="vm.pageCheck((vm.allPools  | filter: query |  excludeByStatus: vm.show.text()).length, vm.current)"/>
      <div class="errors-spacer"></div>
    </form>
    <h3 flex="25" id="surveySearchResults">Results: {{(vm.allPools  | filter: query | excludeByStatus: vm.show.text()).length}} </h3>
    <span>click column heading to sort</span>
    <!-- <div id="filterBoxes" class="row">
      <h3 id="dashFilterBy">Filter By</h3>
      <div layout="column" class="filterBox" ng-repeat="status in vm.show.options">
        <checkbox ng-model="vm.show.statuses[$index]" ng-change="vm.pageCheck((vm.allPools  | filter: query |  excludeByStatus: vm.show.text()).length)">


          {{status}}
        </checkbox>
      </div>
    </div> -->
  </div>
  <!-- end DATABASE VIEW table set up -->

  <!-- DATABASE VIEW table itself -->
  <div class="row">
    <table cellspacing="0">
      <thead>
        <tr id="headerRow">
          <th class="columnSort" width="50" ng-click="vm.setSort('id')">
            Id #</th>

          <th class="columnSort" width="300" ng-click="vm.setSort('name')">
            Name</th>
          <th class="columnSort"  width="180" ng-click="vm.setSort('city')">
            City</th>
          <th class="columnSort" width="50" ng-click="vm.setSort('google_places_data.rating')">
            Rating&nbsp</th>
          <th class="columnSort" width="60" ng-click="vm.setSort('google_places_data.reviews.length')">
            Reviews </th>
          <th class="columnSort" ng-click="vm.setSort('last_updated')">
            Last Modified</th>
          <th class="columnSort" ng-click="vm.setSort('date_added')">
            Date Added </th>
          <th width="20"></th>
        </tr>
      </thead>
      <tbody class="tableBody">
        <tr class="tableBodyRow" data-ng-repeat="result in vm.allPools | excludeByStatus: vm.show.text() | orderBy:vm.sortType:vm.sortReverse | filter: query | startFrom:vm.currentPage*vm.pageSize | limitTo:vm.pageSize">
          <td>{{result.id}}</td>
          <td class="columnSort" ng-click="vm.log(result.google_places_data)">
            {{result.name}}</td>
          <td>{{result.city}}</td>
          <td>{{result.google_places_data.rating}}</td>
          <td>{{result.google_places_data.reviews.length || 0}}</td>
          <td>{{result.last_updated | date:'medium'}}</td>
          <td>{{result.date_added | date:'medium' }}</td>
          <td><div>
            <i ng-click="vm.db.deleteFacility(result.id)" class="fa fa-trash" />
          </div></td>
        </tr>
      </tbody>
    </table>
    <p>
      {{googleData}}
    </p>
  </div> <!-- end DATABASE VIEW table itself -->

  <!-- DATABASE VIEW TABLE controls -->
  <div class="row" ng-show="vm.totalPages((vm.allPools  | filter: query |  excludeByStatus: vm.show.text()).length)">
    <button ng-class="mini" ng-disabled="vm.currentPage == 0" ng-click="vm.currentPage=vm.currentPage-1">
      Previous
    </button>
      {{vm.currentPage+1}}/{{vm.totalPages((vm.allPools  | filter: query | excludeByStatus: vm.show.text()).length)}}
    <button ng-class="mini" ng-disabled="vm.currentPage >= ((vm.allPools  | filter: query | excludeByStatus: vm.show.text()).length / vm.pageSize - 1)" ng-click="vm.currentPage=vm.currentPage+1">
      Next
    </button>
  </div>  <!-- end DATABASE VIEW TABLE controls -->

</div> <!-- end page container -->
